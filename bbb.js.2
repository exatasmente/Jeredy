let app = require('express')();
let http = require('http').Server(app);
let io = require('socket.io')(http);
let b = require('bonescript');
let v = 0;
let conn = false;
var pinos = {
  left:
    {
      front: 'P9_21',
      back: 'P9_16',
      reverse : ['P8_11','P8_15']
    },
  right: {
    front: 'P9_14',
    back: 'P9_22',
   reverse:['P8_12','P8_16']
  }
};

b.pinMode(pinos.left.back, b.OUTPUT);
b.pinMode(pinos.left.front, b.OUTPUT);
b.pinMode(pinos.right.back, b.OUTPUT);
b.pinMode(pinos.right.front, b.OUTPUT);
b.pinMode(pinos.left.reverse[0],b.OUTPUT);
b.pinMode(pinos.right.reverse[0],b.OUTPUT);

b.pinMode(pinos.left.reverse[1],b.OUTPUT);
b.pinMode(pinos.right.reverse[1],b.OUTPUT);

b.digitalWrite(pinos.left.front, 0);
b.digitalWrite(pinos.left.back, 0);
b.digitalWrite(pinos.right.front,0);
b.digitalWrite(pinos.right.back, 0);


io.on('connection', (socket) => {
  socket.on('error',function(){
    conn= false;
    console.log("Erro");
    b.digitalWrite(pinos.left.reverse[0],0);
    b.digitalWrite(pinos.left.reverse[1],0);
    b.digitalWrite(pinos.right.reverse[0],0);
    b.digitalWrite(pinos.right.reverse[1],0);
    b.digitalWrite(pinos.left.front, 0);
    b.digitalWrite(pinos.left.back, 0);
    b.digitalWrite(pinos.right.front, 0);
    b.digitalWrite(pinos.right.back, 0);


    
  });
  socket.on('pair',function(){
    console.log('Nova Conexão');
    if(conn){
      console.log('Negada');
      socket.emit('userOn',{});
    }else{
      console.log('Autorizado');
      socket.emit('userAllowed');
      conn= true;
    }
  });
  socket.on('jeredy',function(){
          conn = false;
	  io.emit('jeredy',{nome: 'Jeredy Controller',
                         versao: 'Palmas 4', 
                         pinos: JSON.stringify(pinos)});
  });

  socket.on('disconnect', function () {
    conn = false;
    io.emit('close', { message: 'Conex  o encerrrada', event: 'close' });
  });

  socket.on('getPins', function () {
    console.log('pinos');
    io.emit('pins', { pinos: pinos, event: 'pinos' });
  });

  socket.on('acelerador', function () {
   b.digitalWrite(pinos.left.reverse[0],0);
   b.digitalWrite(pinos.left.reverse[1],0);
   b.digitalWrite(pinos.right.reverse[0],0);
   b.digitalWrite(pinos.right.reverse[1],0);
   console.log("Acelera : "+v);
   b.digitalWrite(pinos.left.front, 1);
    b.digitalWrite(pinos.left.back, 1);
    b.digitalWrite(pinos.right.back, 1);
    b.digitalWrite(pinos.right.front, 1);
    
    io.emit('acelera', { message: v, event: 'gas' });
  });

  socket.on('freio', function () {

    console.log("Freia");
    b.digitalWrite(pinos.left.reverse[0],0);
    b.digitalWrite(pinos.left.reverse[1],0);
    b.digitalWrite(pinos.right.reverse[0],0);
    b.digitalWrite(pinos.right.reverse[1],0);
    b.digitalWrite(pinos.left.front, 0);
    b.digitalWrite(pinos.left.back, 0);
    b.digitalWrite(pinos.right.front, 0);
    b.digitalWrite(pinos.right.back, 0);

    io.emit('freia', { message: 'Freio', event: 'break' });
  });
  socket.on('esquerda', function () {
    b.digitalWrite(pinos.left.front, 1);
    b.digitalWrite(pinos.left.back, 1);
    b.digitalWrite(pinos.right.front, 0);
    b.digitalWrite(pinos.right.back, 0);
    b.digitalWrite(pinos.right.reverse[0],1);
    b.digitalWrite(pinos.right.reverse[1],1);
    io.emit('esquerda', { message: 'Esquerda', event: 'left' });
    console.log('Esquerda');
  });
  socket.on('direita', function () {
    b.digitalWrite(pinos.right.front, 1);
    b.digitalWrite(pinos.right.back, 1);
    b.digitalWrite(pinos.left.front, 0);
    b.digitalWrite(pinos.left.back, 0);
    b.digitalWrite(pinos.left.reverse[0],1);
    b.digitalWrite(pinos.left.reverse[1],1);
    io.emit('direita', { message: 'Direita', event: 'right' });
    console.log('Direita');
  });
  socket.on('reverso', function () {
    console.log("Ré");
    b.digitalWrite(pinos.left.reverse[0], 1);
    b.digitalWrite(pinos.left.reverse[1],1);
    b.digitalWrite(pinos.right.reverse[0],1);
    b.digitalWrite(pinos.right.reverse[1],1);
    io.emit('re', { message: 'Re', event: 'reverse' });
  });

});

var port = 1337;

http.listen(port, function () {
  console.log('listening in http://192.168.0.13:' + port);
});



